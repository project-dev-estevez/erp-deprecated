<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * 
 */
class Pedidos_model extends CI_Model {
    public function __construct() {
        parent::__construct();
        $this->load->database();
    }

    public function datospedido($uid) {
        $resultado['pedido']=$this->detalle_pedido($uid);
        if($resultado['pedido']){
            $resultado['detalle']=$this->detalle_pedido_catalogo($resultado['pedido']->idtbl_pedidos);
            return $resultado;
        }else
            return false;
    }
    
    public function pedidos($buscar='', $inicio = false, $cantidadRegistro = false, $buscar2='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar2 == 'Ceros'){
            $estatus = ' AND dtl_pedido_catalogo.entregado = 0 ';
            $order = ' tbl_pedidos.idtbl_pedidos DESC';
        } elseif($buscar2 == 'Avance') {
            $estatus = ' AND dtl_pedido_catalogo.entregado > 0 ';
            $order = ' dtl_pedido_catalogo.entregado ASC';
        }else{
            $estatus = ' ';
            $order = ' tbl_pedidos.idtbl_pedidos DESC';
        }
        /*$this->db->select('tbl_proyectos.nombre_proyecto');
        $this->db->select('tbl_proyectos.numero_proyecto');
        $this->db->select('tbl_pedidos.*');
        $this->db->select('tbl_users.nombre');
        $this->db->select('tbl_clientes.nombre_comercial');
        $this->db->select('tbl_solicitudes_almacen.uid as uid_requisicion');
        $this->db->select('tbl_catalogo.neodata');

        $this->db->from('tbl_pedidos');         

        $this->db->join('tbl_proyectos','tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos','left');
        $this->db->join('tbl_users','tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users','left');
        $this->db->join('tbl_clientes','tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes','left');
        $this->db->join('tbl_solicitudes_almacen','tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen','left');
        $this->db->join('dtl_pedido_catalogo', 'dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos', 'left');
        $this->db->join('tbl_catalogo', 'tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo', 'left');
        

        $query = $this->db->get();*/
        if(isset($_POST['estatus'])){
            if(isset($_POST['almacen_reporte'])){
                $estatus_pedido = $this->input->post('estatus');
                $almacen = $this->input->post('almacen_reporte');
                $fecha = '';
                $proyecto = '';
                $where_proyecto = '';
                if((isset($_POST['fecha_inicio']) && $this->input->post('fecha_inicio') != '') && (isset($_POST['fecha_final']) && $this->input->post('fecha_final') != '')){
                    $fecha_inicio = $this->input->post('fecha_inicio');
                    $fecha_final = $this->input->post('fecha_final');
                    $fecha = " AND tbl_pedidos.fecha_creacion BETWEEN '$fecha_inicio' AND '$fecha_final'";
                }
                if(isset($_POST['proyecto']) && $this->input->post('proyecto') != ''){
                    $proyecto = $this->input->post('proyecto');
                    $where_proyecto = " AND tbl_pedidos.tbl_proyectos_idtbl_proyectos = $proyecto";
                }
                if($almacen != '' && $almacen != NULL){
                    if($this->input->post('estatus') == 'pendientes'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND (tbl_pedidos.estatus != 'cancelada' OR tbl_pedidos.estatus IS NULL) AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = $almacen AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto "." " . $limit);
                    }elseif($this->input->post('estatus') == 'progreso'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = $almacen AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto ORDER BY $order "." " . $limit);
                    }elseif($this->input->post('estatus') == 'finalizado'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = $almacen AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto ORDER BY $order "." " . $limit);
                    }elseif($this->input->post('estatus') == 'cancelado'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.estatus = 'cancelada' AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = $almacen AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto "." " . $limit);
                    }
                }else{
                    if($this->input->post('estatus') == 'pendientes'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND (tbl_pedidos.estatus != 'cancelada' OR tbl_pedidos.estatus IS NULL) AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto "." " . $limit);
                    }elseif($this->input->post('estatus') == 'progreso'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto ORDER BY $order "." " . $limit);
                    }elseif($this->input->post('estatus') == 'finalizado'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto ORDER BY $order "." " . $limit);
                    }elseif($this->input->post('estatus') == 'cancelado'){
                        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, tbl_catalogo.descripcion, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_pedidos.uid AS uid_pedido, tbl_pedidos.fecha_creacion AS fecha_pedido FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.estatus = 'cancelada' AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $fecha $where_proyecto "." " . $limit);
                    }
                }
            }else{
                $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 $estatus AND tbl_pedidos.estimacion = 0 AND (tbl_pedidos.estatus != 'cancelada' OR tbl_pedidos.estatus IS NULL) AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene IS NULL ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0)  $estatus AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene IS NULL ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos))  $estatus AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene IS NULL ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'cancelado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 $estatus AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.estatus = 'cancelada' AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene IS NULL ORDER BY $order "." " . $limit);
                }
            }
        }else{
            if($this->session->userdata('tipo') == 14 || $this->session->userdata('id') == 50 || $this->session->userdata('tipo') == 3 || $this->session->userdata('tipo') == 10){
                $usuario = $this->session->userdata('id');
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_pedidos.tbl_users_idtbl_users_solicitud = $usuario $estatus ORDER BY $order " . " " . $limit);
            }else if($this->session->userdata('tipo') == 1){
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_pedidos.tbl_users_idtbl_users_solicitud = 3 $estatus ORDER BY ". $order . " " . $limit);
            //}else if($this->session->userdata('tipo') == 7){
            //  $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene IS NULL ORDER BY ". $order . " " . $limit);
            }else if($this->session->userdata('tipo') == 7){
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 50 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 66) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) $estatus ORDER BY $order " . " " . $limit);
            }else if($this->session->userdata('tipo') == 2){
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND (tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 30) $estatus ORDER BY $order "." " . $limit);
            }elseif($this->session->userdata('id') == 263){
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') $estatus AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND (tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 228) ORDER BY $order "." " . $limit);
            }else{
                $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_proveedores.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_proveedores ON tbl_pedidos.tbl_proveedores_idtbl_proveedores=tbl_proveedores.idtbl_proveedores LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') $estatus AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 50 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 3 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 66) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) ORDER BY $order "." " . $limit);
            }
        }

        return $query->result();
    }

    //Traer pedidos virtuales
    public function pedidos_virtuales($buscar='', $inicio = false, $cantidadRegistro = false, $buscar2='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar2 != Null || $buscar2 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        /*$this->db->select('tbl_proyectos.nombre_proyecto');
        $this->db->select('tbl_proyectos.numero_proyecto');
        $this->db->select('tbl_pedidos.*');
        $this->db->select('tbl_users.nombre');
        $this->db->select('tbl_clientes.nombre_comercial');
        $this->db->select('tbl_solicitudes_almacen.uid as uid_requisicion');
        $this->db->select('tbl_catalogo.neodata');

        $this->db->from('tbl_pedidos');         

        $this->db->join('tbl_proyectos','tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos','left');
        $this->db->join('tbl_users','tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users','left');
        $this->db->join('tbl_clientes','tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes','left');
        $this->db->join('tbl_solicitudes_almacen','tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen','left');
        $this->db->join('dtl_pedido_catalogo', 'dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos', 'left');
        $this->db->join('tbl_catalogo', 'tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo', 'left');
        

        $query = $this->db->get();*/
        $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tbl_proveedores.nombre_comercial FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_proveedores ON tbl_proveedores.idtbl_proveedores = tbl_pedidos.tbl_proveedores_idtbl_proveedores LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 1 ORDER BY ". $order . " " . $limit);

        return $query->result();
    }

    //Traer pedidos virtuales

    public function pedidos_kuali($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 16 AND tbl_solicitudes_almacen.tipo_kuali IS NULL ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 16 AND tbl_solicitudes_almacen.tipo_kuali IS NULL ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 16 AND tbl_solicitudes_almacen.tipo_kuali IS NULL ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 16 AND tbl_solicitudes_almacen.tipo_kuali IS NULL ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    //Traer pedidos virtuales
    public function pedidos_cv($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    //Traer pedidos virtuales
    public function pedidos_cv_excel($estatus, $buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        
                if($estatus == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }elseif($estatus == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }elseif($estatus == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 29 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    //Traer pedidos AC

    public function pedidos_ac($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 2 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 2 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 2 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 2 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    //Traer pedidos AM

    public function pedidos_am($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }        
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }                   
    $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 23 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 23 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 23 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 23 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }


    public function pedidos_ehs($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene = 1 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 50 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 3 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 66) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene = 1 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 50 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 3 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 66) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene = 1 AND ((tbl_pedidos.tbl_users_idtbl_users_solicitud <> 69 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 50 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 3 AND tbl_pedidos.tbl_users_idtbl_users_solicitud <> 66) OR tbl_pedidos.tbl_users_idtbl_users_solicitud IS NULL) ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 1 AND tbl_solicitudes_almacen.tipo_seguridad_e_higiene = 1 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    public function pedidos_kualidekuali($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tipo_kuali = 1 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tipo_kuali = 1 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tipo_kuali = 1 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 16 AND tbl_solicitudes_almacen.tipo_kuali = 1 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    public function pedidos_ad($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {        
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 357");
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 357 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 357 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 357 ORDER BY $order "." " . $limit);
                }
    

        return $query->result();
    }

    public function pedidos_personal($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 398");
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 398 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 398 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 398 ORDER BY $order "." " . $limit);
                }
    

        return $query->result();
    }

    public function pedidos_makili($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
        if($this->input->post('estatus') == 'Pendientes'){
            $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 421");
        }elseif($this->input->post('estatus') == 'Progreso'){
            $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 421 ORDER BY $order "." " . $limit);
        }elseif($this->input->post('estatus') == 'Finalizado'){
            $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 421 ORDER BY $order "." " . $limit);
        }else{
            $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 421 ORDER BY $order "." " . $limit);
        }
               /* if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 406");
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 406 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 406 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 406 ORDER BY $order "." " . $limit);
                } ruth*/ 
    

        return $query->result();
    }

    public function pedidos_mt($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';        
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }
        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 358");
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 358 ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 358 ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 358 ORDER BY $order "." " . $limit);
                }
    

        return $query->result();
    }

    //Traer pedidos virtuales
    public function pedidos_sistemas($buscar='', $inicio = false, $cantidadRegistro = false, $buscar3='') {
        $limit = '';
        if($inicio !== false && $cantidadRegistro !== false) {
            $limit = 'LIMIT ' . $inicio . "," . $cantidadRegistro;
        }


        if($buscar3 != Null || $buscar3 != ''){
            $order = 'dtl_pedido_catalogo.entregado ASC';
        } else {
            $order = 'tbl_pedidos.idtbl_pedidos DESC';
        }
        if($this->session->userdata('tipo') == 7){
            $validacion_kuali = " AND tbl_solicitudes_almacen.tipo_kuali IS NULL AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 30 ";
        }else{
            $validacion_kuali = " AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 30 ";
        }
        $estatus_pedido = $this->input->post('estatus');
                if($this->input->post('estatus') == 'Pendientes'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = 0 AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 $validacion_kuali ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Progreso'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) < (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AND (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) > 0) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 $validacion_kuali ORDER BY $order "." " . $limit);
                }elseif($this->input->post('estatus') == 'Finalizado'){
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata, tusol.tipo, (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_pedida, (SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) AS cantidad_entregada FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_users tusol ON tusol.idtbl_users = tbl_pedidos.tbl_users_idtbl_users_solicitud LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND ((SELECT SUM(dpc.entregado) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos) = (SELECT SUM(dpc.cantidad) FROM dtl_pedido_catalogo dpc WHERE dpc.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos)) AND tbl_pedidos.estimacion = 0 AND tbl_pedidos.entrada_virtual = 0 $validacion_kuali ORDER BY $order "." " . $limit);
                }else{
                    $query = $this->db->query("SELECT tbl_proyectos.nombre_proyecto, tbl_proyectos.numero_proyecto, tbl_pedidos.*, tbl_users.nombre, tbl_clientes.nombre_comercial, tbl_solicitudes_almacen.uid as uid_requisicion, tbl_catalogo.neodata FROM tbl_pedidos LEFT JOIN tbl_proyectos ON tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos LEFT JOIN tbl_users ON tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users LEFT JOIN tbl_clientes ON tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes LEFT JOIN tbl_solicitudes_almacen ON tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen LEFT JOIN dtl_pedido_catalogo ON dtl_pedido_catalogo.iddtl_pedido_catalogo = tbl_pedidos.idtbl_pedidos LEFT JOIN tbl_catalogo ON tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo WHERE (tbl_pedidos.uid LIKE '%$buscar%' OR tbl_pedidos.neodata_pedido LIKE '%$buscar%' OR tbl_pedidos.fecha_creacion LIKE '%$buscar%' OR tbl_solicitudes_almacen.uid LIKE '%$buscar%' OR tbl_users.nombre LIKE '%$buscar%' OR tbl_proyectos.numero_proyecto LIKE '%$buscar%' OR tbl_proyectos.nombre_proyecto LIKE '%$buscar%') AND tbl_pedidos.estimacion = 0 AND tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = 30 ORDER BY ". $order . " " . $limit);
                }
    

        return $query->result();
    }

    public function detalle_pedido($uid) {

        $this->db->select('tbl_proyectos.nombre_proyecto');
        $this->db->select('tbl_proyectos.numero_proyecto');
        $this->db->select('tbl_proyectos.direccion');
        $this->db->select('tbl_segmentos_proyecto.segmento');
        $this->db->select('tbl_pedidos.*');
        $this->db->select('tbl_users.nombre');
        $this->db->select('tbl_clientes.nombre_comercial as nombre_comercial_cliente');
        $this->db->select('tbl_solicitudes_almacen.uid as uid_requisicion');
        $this->db->select('tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes');      
        $this->db->select('tbl_proveedores.nombre_fiscal, tbl_proveedores.rfc');
        $this->db->select('tbl_almacenes.almacen');
        $this->db->select('SUM(dtl_pedido_catalogo.cantidad) AS cantidad, SUM(dtl_pedido_catalogo.entregado) AS entregado');


        $this->db->from('tbl_pedidos');         

        $this->db->join('dtl_pedido_catalogo', 'dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos', 'left');
        $this->db->join('tbl_proyectos','tbl_pedidos.tbl_proyectos_idtbl_proyectos=tbl_proyectos.idtbl_proyectos','left');
        $this->db->join('tbl_segmentos_proyecto','tbl_segmentos_proyecto.idtbl_segmentos_proyecto = tbl_pedidos.tbl_segmentos_proyecto_idtbl_segmentos_proyecto','left');
        $this->db->join('tbl_users','tbl_pedidos.tbl_users_idtbl_users=tbl_users.idtbl_users','left');
        $this->db->join('tbl_clientes','tbl_proyectos.tbl_clientes_idtbl_clientes=tbl_clientes.idtbl_clientes','left');
        $this->db->join('tbl_solicitudes_almacen','tbl_solicitudes_almacen.idtbl_solicitudes_almacen=tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen','left');
        $this->db->join('tbl_almacenes', 'tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes = tbl_almacenes.idtbl_almacenes', 'left');
        $this->db->join('tbl_proveedores','tbl_proveedores.idtbl_proveedores = tbl_pedidos.tbl_proveedores_idtbl_proveedores','left');
        $this->db->group_by('dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos');

        $this->db->where('tbl_pedidos.uid', $uid);

        $query = $this->db->get();
        $resultado = $query->result();
        
        if(count($resultado)>0)
            return $query->result()[0];
        else
            return false;
    }
    
    public function detalle_pedido_catalogo($id_pedido) {
        $this->db->select('dtl_pedido_catalogo.*');
        $this->db->select('tbl_catalogo.descripcion');
        $this->db->select('tbl_catalogo.uid');
        $this->db->select('tbl_catalogo.neodata');
        //$this->db->select('MAX(dtl_almacen.numero_interno) AS ultimo_numero_interno', FALSE);
        $this->db->select('tbl_catalogo.ctl_categorias_idctl_categorias');
        $this->db->select('TC.descripcion AS descripcion_pedido');
        $this->db->select('TC.uid AS uid_pedido');
        $this->db->select('TC.neodata AS neodata_pedido');
        $this->db->select('TC.ctl_categorias_idctl_categorias AS categoria_pedido');
        $this->db->select('tbl_pedidos.lugar_entrega');
        $this->db->select('tbl_proveedores.nombre_fiscal');
        $this->db->select('ctl_unidades_medida.unidad_medida_abr');
        //$this->db->select('(CASE WHEN dtl_almacen.numero_interno REGEXP "^[0-9]+$" THEN CAST(dtl_almacen.numero_interno AS SIGNED) + 1 WHEN dtl_almacen.numero_interno REGEXP "^[A-Za-z0-9]*$" THEN CONCAT( SUBSTRING(dtl_almacen.numero_interno, 1, CHAR_LENGTH(dtl_almacen.numero_interno) - LENGTH(CAST(dtl_almacen.numero_interno AS SIGNED))), CAST(CAST(SUBSTRING(dtl_almacen.numero_interno, CHAR_LENGTH(dtl_almacen.numero_interno) - LENGTH(CAST(dtl_almacen.numero_interno AS SIGNED))) AS SIGNED) + 1 AS CHAR)) ELSE dtl_almacen.numero_interno END) AS siguiente_numero_interno', FALSE);
        $this->db->from('dtl_pedido_catalogo');         
        $this->db->join('tbl_pedidos', 'tbl_pedidos.idtbl_pedidos=dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos', 'left');
        $this->db->join('tbl_proveedores', 'tbl_proveedores.idtbl_proveedores=tbl_pedidos.tbl_proveedores_idtbl_proveedores', 'left');
        $this->db->join('tbl_catalogo','tbl_catalogo.idtbl_catalogo=dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo','left');
        //$this->db->join('dtl_almacen', 'dtl_almacen.tbl_catalogo_idtbl_catalogo = tbl_catalogo.idtbl_catalogo', 'left');
        $this->db->join('tbl_catalogo TC', 'TC.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo_pedido', 'left');
        $this->db->join('ctl_unidades_medida','tbl_catalogo.ctl_unidades_medida_idctl_unidades_medida=ctl_unidades_medida.idctl_unidades_medida','left');
        //$this->db->where("dtl_almacen.numero_interno NOT LIKE '%VENTA%'");
        //$this->db->where("dtl_almacen.numero_interno NOT LIKE '%RENTA%'");
        $this->db->where('dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos', $id_pedido);
        //$this->db->order_by('dtl_almacen.numero_interno', 'DESC');
        //$this->db->group_by('dtl_pedido_catalogo.iddtl_pedido_catalogo');
        $query = $this->db->get();
        return $query->result();
    }

    public function cambiarEstatusPedido($parametros, $uid_pedido) {
        $this->db->trans_begin();

        $query = $this->db->get_where("tbl_pedidos", array("uid" => $uid_pedido));
        $resultPedido = $query->result();

        $query = $this->db->get_where("tbl_almacen_movimientos", array("parent" => $resultPedido[0]->idtbl_pedidos, "tipo" => "entrada-almacen"));
        $result = $query->result();
        
        if(!empty($result)){
            foreach ($result as $value) {
                //var_dump($value);
                $query = $this->db->get_where("dtl_almacen_movimientos", array("tbl_almacen_movimientos_idtbl_almacen_movimientos" => $value->idtbl_almacen_movimientos ));
                $result1 = $query->result();
                foreach ($result1 as $value1){
                    $this->db->where('tbl_almacenes_idtbl_almacenes', $value->tbl_almacenes_idtbl_almacenes);
                    $this->db->where('tbl_catalogo_idtbl_catalogo', $value1->tbl_catalogo_idtbl_catalogo);
                    $q = $this->db->get('dtl_almacen');
                    if ($q->num_rows() > 0) {
                        $this->db->set('existencias', 'existencias-' . $value1->cantidad, FALSE);
                        $this->db->where('tbl_almacenes_idtbl_almacenes', $value->tbl_almacenes_idtbl_almacenes);
                        $this->db->where('tbl_catalogo_idtbl_catalogo', $value1->tbl_catalogo_idtbl_catalogo);
                        $this->db->update('dtl_almacen');
                    }
                }
                $this->db->set('cantidad', 0);
                $this->db->where('tbl_almacen_movimientos_idtbl_almacen_movimientos', $value->idtbl_almacen_movimientos);
                $this->db->update('dtl_almacen_movimientos');
            }
            $this->db->set('entregado', 0);
            $this->db->where('tbl_pedidos_idtbl_pedidos', $resultPedido[0]->idtbl_pedidos);
            $this->db->update('dtl_pedido_catalogo');
        }

        $this->db->where('uid', $uid_pedido);
        $this->db->update('tbl_pedidos', $parametros);

        if ($this->db->trans_status() === FALSE) {
            $this->db->trans_rollback();
            return 'Ocurrio un error intente nuevamente';
        } else {
            $this->db->trans_commit();
            return true;
        }
    }

    public function agregarEditarPagoPedido(){
        if($this->input->post("tipo_pago") < 3){
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("numero_tarjeta"),
                $this->input->post("idtbl_pedidos"),
                $this->input->post("banco"),
                $this->input->post("importe_pago")
            ];
        }else if($this->input->post("tipo_pago") == 3){
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("idtbl_pedidos")
            ];
        }else if($this->input->post("tipo_pago") == 5){
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("idtbl_pedidos"),
                $this->input->post("importe_pago_monedero_electronico"),
            ];
        }else if($this->input->post("tipo_pago") == 6){
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("idtbl_pedidos"),
                $this->input->post("importe_nota_credito"),
                $this->input->post("numero_nota_credito")
            ];
        }else if($this->input->post("tipo_pago") == 7){
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("idtbl_pedidos"),
                $this->input->post("cheque_banco"),
                $this->input->post("numero_cheque")
            ];
        }else{
            $array = [
                $this->input->post("importe_pedido"),
                $this->input->post("fecha_factura"),
                $this->input->post("folio_pago"),
                $this->input->post("numero_factura"),
                $this->input->post("fecha_pago"),
                $this->input->post("importe"),
                $this->input->post("tipo_cambio"),
                $this->input->post("tipo_pago"),
                $this->input->post("idtbl_pedidos"),
                $this->input->post("banco"),
                $this->input->post("importe_pago")
            ];
        }
        
        if($this->input->post("iddtl_pagos") == ""){
            if($this->input->post("tipo_pago") < 3){
                $sql = "INSERT INTO dtl_pagos(importe_pedido, fecha_factura, folio_pago, numero_factura, fecha_pago, importe, tipo_cambio, tipo_pago, numero_tarjeta, tbl_pedidos_idtbl_pedidos, tbl_bancos_idtbl_bancos, importe_pago) VALUES(?,?,?,?,?,?,?,?,?,?,?,?)";
            }else if($this->input->post("tipo_pago") == 3){
                $sql = "INSERT INTO dtl_pagos(importe_pedido, fecha_factura, folio_pago, numero_factura, fecha_pago, importe, tipo_cambio, tipo_pago, tbl_pedidos_idtbl_pedidos) VALUES(?,?,?,?,?,?,?,?,?)";
            }else if($this->input->post("tipo_pago") == 5){
                $sql = "INSERT INTO dtl_pagos(importe_pedido, fecha_factura, folio_pago, numero_factura, fecha_pago, importe, tipo_cambio, tipo_pago, tbl_pedidos_idtbl_pedidos, importe_pago) VALUES(?,?,?,?,?,?,?,?,?,?)";
            }else if($this->input->post("tipo_pago") == 6){
                $sql = "INSERT INTO dtl_pagos(importe_pedido, fecha_factura, folio_pago, numero_factura, fecha_pago, importe, tipo_cambio, tipo_pago, tbl_pedidos_idtbl_pedidos, importe_pago, numero_nota_credito) VALUES(?,?,?,?,?,?,?,?,?,?,?)";
            }else{
                $sql = "INSERT INTO dtl_pagos(importe_pedido, fecha_factura, folio_pago, numero_factura, fecha_pago, importe, tipo_cambio, tipo_pago, tbl_pedidos_idtbl_pedidos, tbl_bancos_idtbl_bancos, importe_pago) VALUES(?,?,?,?,?,?,?,?,?,?,?)";
            }
        }else{
            $array[] = $this->input->post("iddtl_pagos");
            if($this->input->post("tipo_pago") < 3){
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, numero_tarjeta = ?, tbl_pedidos_idtbl_pedidos = ?, tbl_bancos_idtbl_bancos = ?, importe_pago = ?, numero_nota_credito = NULL, numero_cheque = NULL WHERE iddtl_pagos = ?";
            }else if($this->input->post("tipo_pago") == 3){
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, numero_tarjeta = NULL, tbl_pedidos_idtbl_pedidos = ?, tbl_bancos_idtbl_bancos = NULL, importe_pago = NULL, numero_nota_credito = NULL, numero_cheque = NULL WHERE iddtl_pagos = ?";
            }else if($this->input->post("tipo_pago") == 5){
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, numero_tarjeta = NULL, tbl_pedidos_idtbl_pedidos = ?, importe_pago = ?, tbl_bancos_idtbl_bancos = NULL, numero_nota_credito = NULL, numero_cheque = NULL WHERE iddtl_pagos = ?";
            }else if($this->input->post("tipo_pago") == 6){
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, tbl_pedidos_idtbl_pedidos = ?, importe_pago = ?, numero_nota_credito = ?, tbl_bancos_idtbl_bancos = NULL, numero_tarjeta = NULL, numero_cheque = NULL WHERE iddtl_pagos = ?";
            }else if($this->input->post("tipo_pago") == 7){
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, tbl_pedidos_idtbl_pedidos = ?, tbl_bancos_idtbl_bancos = ?, numero_cheque = ?, numero_nota_credito = NULL, numero_tarjeta = NULL WHERE iddtl_pagos = ?";
            }else{
                $sql = "UPDATE dtl_pagos SET importe_pedido = ?, fecha_factura = ?, folio_pago = ?, numero_factura = ?, fecha_pago = ?, importe = ?, tipo_cambio = ?, tipo_pago = ?, numero_tarjeta = NULL, tbl_pedidos_idtbl_pedidos = ?, tbl_bancos_idtbl_bancos = ?, importe_pago = ?, numero_nota_credito = NULL, numero_cheque = NULL WHERE iddtl_pagos = ?";
            }
        }
        $resultado = $this->db->query($sql, $array);
        if(isset($resultado)){
            return true;
        }else{
            return false;
        }
    }

    public function cerrarPedido(){
        $array = [
            "cerrada",
            $this->input->post("uid_pedido")
        ];
        $sql = "UPDATE tbl_pedidos SET estatus = ? WHERE uid = ?";
        $resultado = $this->db->query($sql, $array);
        if(isset($resultado)){
            return true;
        }else{
            return false;
        }
    }

    public function bancos(){
        $sql = "SELECT * FROM tbl_bancos";
        return $this->db->query($sql)->result_array();
    }

    public function pago_pedido(){
        $array = [
            $this->input->post("idtbl_pedidos")
        ];
        $sql = "SELECT * FROM dtl_pagos WHERE tbl_pedidos_idtbl_pedidos = ?";
        return $this->db->query($sql, $array)->result();
    }

    public function actualizarCantidadAlmacen(){
        $this->db->trans_begin();
        $this->db->select("dtl_almacen_movimientos.*, tbl_almacen_movimientos.tbl_almacenes_idtbl_almacenes");
        $this->db->from("dtl_almacen_movimientos");
        $this->db->join("tbl_almacen_movimientos", "tbl_almacen_movimientos.idtbl_almacen_movimientos = dtl_almacen_movimientos.tbl_almacen_movimientos_idtbl_almacen_movimientos");
        $this->db->where("tbl_almacen_movimientos.parent", $_POST['idtbl_solicitudes_almacen']);
        $result = $this->db->get()->result();
        foreach ($result as $value) {
            $this->db->set('existencias', 'existencias - ' . $value->entregado, FALSE);
            $this->db->where('tbl_catalogo_idtbl_catalogo', $value->tbl_catalogo_idtbl_catalogo);
            $this->db->where('estatus', 'almacen');
            $this->db->where('tbl_almacenes_idtbl_almacenes', $value->tbl_almacenes_idtbl_almacenes);
            $query = $this->db->update("dtl_almacen");
        }
        if ($this->db->trans_status() === FALSE) {
            $this->db->trans_rollback();
            return false;
        } else {
            $this->db->trans_commit();
            return true;
        }
    }

    //Query para traer los datos del producto
  public function ultimoPedido($idcatalogo){
	$this->db->select('dtl_almacen.existencias, tbl_pedidos.idtbl_pedidos, tbl_pedidos.fecha_creacion AS ultima_fecha, dtl_pedido_catalogo.cantidad, dtl_pedido_catalogo.entregado, tbl_catalogo.idtbl_catalogo, tbl_pedidos.uid');
	$this->db->from('tbl_pedidos');
	$this->db->join('dtl_pedido_catalogo', 'dtl_pedido_catalogo.tbl_pedidos_idtbl_pedidos = tbl_pedidos.idtbl_pedidos', 'left');
	$this->db->join('tbl_catalogo', 'tbl_catalogo.idtbl_catalogo = dtl_pedido_catalogo.tbl_catalogo_idtbl_catalogo', 'left');
	$this->db->join('dtl_almacen', 'dtl_almacen.tbl_catalogo_idtbl_catalogo = tbl_catalogo.idtbl_catalogo', 'left');
    $this->db->join('tbl_solicitudes_almacen', 'tbl_solicitudes_almacen.idtbl_solicitudes_almacen = tbl_pedidos.tbl_solicitudes_almacen_idtbl_solicitudes_almacen', 'left');
	$this->db->where('tbl_catalogo.idtbl_catalogo', $idcatalogo);
	$this->db->where('dtl_almacen.estatus', 'almacen');
    $this->db->where('dtl_almacen.tbl_almacenes_idtbl_almacenes', $this->input->post('id_almacen'));
	$this->db->where('tbl_pedidos.fecha_creacion < (SELECT MAX(fecha_creacion) FROM tbl_pedidos tp JOIN dtl_pedido_catalogo dpc ON dpc.tbl_pedidos_idtbl_pedidos = tp.idtbl_pedidos WHERE dpc.tbl_catalogo_idtbl_catalogo = tbl_catalogo.idtbl_catalogo)');
    $this->db->where('tbl_solicitudes_almacen.tbl_almacenes_idtbl_almacenes', $this->input->post('id_almacen'));
    $this->db->order_by('tbl_pedidos.idtbl_pedidos DESC');
    $this->db->limit(1);
	$query = $this->db->get();
	return $query->result();
}

}